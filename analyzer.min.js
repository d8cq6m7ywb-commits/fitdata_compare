let globalParsedA=null,globalParsedB=null,globalParsedC=null,globalAligned=null;const metricCharts={};let pdcChart=null;async function parseFitFile(e){return new Promise((t,r)=>{let l=new FileReader;l.onload=e=>{try{let l=e.target.result;if(!window.FitEntry||"function"!=typeof window.FitEntry.parseFitToTimeSeries){r(Error("FitEntry.parseFitToTimeSeries is not available"));return}let a=window.FitEntry.parseFitToTimeSeries(l);Promise.resolve(a).then(t).catch(r)}catch(n){r(n)}},l.onerror=r,l.readAsArrayBuffer(e)})}function alignTimeSeries(e,t,r,l=1){let a=e.timestamps||[],n=t.timestamps||[];if(!a.length||!n.length)throw Error("Missing timestamps in one of the files.");let i=a[0],o=a[a.length-1],s=n[0],d=n[n.length-1],c=Math.max(i,s),u=Math.min(o,d);if(!Number.isFinite(c)||!Number.isFinite(u)||u<=c)throw Error("No overlapping time range between Device A and B.");let m=[];for(let p=c;p<=u;p+=l)m.push(p);function h(e,t){if(!e||!Array.isArray(e.timestamps))return null;let r=e.timestamps,a=e[t];if(!Array.isArray(a))return null;let n=Array(m.length).fill(null),i=0;for(let o=0;o<m.length;o++){let s=m[o];for(;i+1<r.length&&Math.abs(r[i+1]-s)<Math.abs(r[i]-s);)i++;let d=Math.abs(r[i]-s);d<=l/2?n[o]=a[i]:n[o]=null}return n}let g=["power","heartRate","speed","cadence"],f={times:m,A:{},B:{},C:{}};return g.forEach(r=>{f.A[r]=h(e,r),f.B[r]=h(t,r)}),r&&Array.isArray(r.timestamps)&&r.timestamps.length?g.forEach(e=>{f.C[e]=h(r,e)}):g.forEach(e=>{f.C[e]=null}),f}function basicStats(e,t){if(!Array.isArray(e))return null;let r=0,l=0,a=1/0,n=-1/0,i=0,o=0,s=[];for(let d of e){if(null==d||"heartRate"===t&&0===d){o++;continue}s.push(d),r++,l+=d,d<a&&(a=d),d>n&&(n=d),0===d&&"heartRate"!==t&&i++}if(!r)return{count:0,mean:null,min:null,max:null,zeroCount:i,zeroPct:0,dropoutCount:o,dropoutPct:e.length?o/e.length*100:0,std:null};let c=l/r,u=0;for(let m of s)u+=(m-c)*(m-c);let p=Math.sqrt(u/Math.max(1,r-1));return{count:r,mean:c,min:a,max:n,zeroCount:i,zeroPct:i/r*100,dropoutCount:o,dropoutPct:o/e.length*100,std:p}}function compareSeries(e,t,r){if(!Array.isArray(e)||!Array.isArray(t))return null;let l=0,a=0,n=0;for(let i=0;i<e.length;i++){let o=e[i],s=t[i];if(null==o||null==s||"power"===r&&o<=0)continue;let d=s-o;l+=d,0!==o&&(a+=d/o),n++}return n?{meanDiff:l/n,meanRelDiffPct:a/n*100,sampleCount:n}:null}function computeStatsForMetric(e,t){let r=e.A[t],l=e.B[t],a=e.C?e.C[t]:null,n=Array.isArray(r)?basicStats(r,t):null,i=Array.isArray(l)?basicStats(l,t):null,o=Array.isArray(a)?basicStats(a,t):null,s=n&&i?compareSeries(r,l,t):null,d=n&&o?compareSeries(r,a,t):null;return{statsA:n,statsB:i,statsC:o,compBA:s,compCA:d}}function formatTimeFromMinutes(e){if(!Number.isFinite(e))return"";let t=Math.round(60*e);if(t<90)return`${t}s`;let r=Math.round(t/60),l=Math.floor(r/60);if(0===l)return`${r}m`;let a=(r%60).toString().padStart(2,"0");return`${l}h${a}`}function attachDragZoom(e){let t=e.canvas,r=!1,l=null;t.addEventListener("mousedown",e=>{let a=t.getBoundingClientRect();r=!0,l=e.clientX-a.left}),t.addEventListener("mouseup",a=>{if(!r)return;r=!1;let n=t.getBoundingClientRect(),i=a.clientX-n.left,o=Math.abs(i-l);if(o<5)return;let s=e.scales.x,d=Math.min(l,i),c=Math.max(l,i),u=s.getValueForPixel(d),m=s.getValueForPixel(c);e.options.scales.x.min=u,e.options.scales.x.max=m,e.update("none")}),t.addEventListener("dblclick",()=>{e.options.scales.x.min=void 0,e.options.scales.x.max=void 0,e.update("none")})}function resetMetricZoom(e){let t=metricCharts[e];t&&(t.options.scales.x.min=void 0,t.options.scales.x.max=void 0,t.update("none"))}function resetPdcZoom(){pdcChart&&(pdcChart.options.scales.x.min=void 0,pdcChart.options.scales.x.max=void 0,pdcChart.update("none"))}function renderMetricChart(e,t,r){let l=document.getElementById(r);if(!l)return;let a=e.A[t],n=e.B[t],i=e.C?e.C[t]:null,o=Array.isArray(a)&&a.some(e=>null!=e),s=Array.isArray(n)&&n.some(e=>null!=e),d=Array.isArray(i)&&i.some(e=>null!=e);if(!o&&!s&&!d){metricCharts[t]&&(metricCharts[t].destroy(),metricCharts[t]=null);return}let c=l.getContext("2d"),u=e.times[0],m=e.times.map(e=>(e-u)/60),p=[];o&&p.push({label:"Device A",data:a,spanGaps:!0,borderWidth:1,pointRadius:0,pointHitRadius:4}),s&&p.push({label:"Device B",data:n,spanGaps:!0,borderWidth:1,pointRadius:0,pointHitRadius:4}),d&&p.push({label:"Device C",data:i,spanGaps:!0,borderWidth:1,pointRadius:0,pointHitRadius:4}),metricCharts[t]&&metricCharts[t].destroy();let h=new Chart(c,{type:"line",data:{labels:m,datasets:p},options:{responsive:!0,interaction:{mode:"nearest",intersect:!1},scales:{x:{title:{display:!0,text:"Time"},ticks:{callback(e){let t=this.getLabelForValue?this.getLabelForValue(e):e,r=Number(t);return formatTimeFromMinutes(r)}}},y:{title:{display:!0,text:{power:"Power (W)",heartRate:"Heart rate (bpm)",speed:"Speed (m/s)",cadence:"Cadence (rpm)"}[t]||t}}}}});metricCharts[t]=h,attachDragZoom(h)}function computePDC(e,t){if(!e)return null;let r=e.power||[];if(!r.length)return null;let l=r.map(e=>null==e?0:e);return t.map(e=>{let t=Math.max(1,Math.round(e));if(t>l.length)return 0;let r=0;for(let a=0;a<t;a++)r+=l[a];let n=r/t;for(let i=t;i<l.length;i++){r+=l[i]-l[i-t];let o=r/t;o>n&&(n=o)}return n})}function formatDurationTick(e){let t=60*e;if(t<60)return`${Math.round(t)}s`;let r=Math.round(t/60);if(r<60)return`${r}m`;let l=(r%60).toString().padStart(2,"0");return`${Math.floor(r/60)}h${l}`}function renderPDC(e,t,r){let l=[5,10,15,20,30,45,60,90,120,180,240,300,420,600,900,1200,1800],a=l.map(e=>e/60),n=computePDC(e,l),i=computePDC(t,l),o=computePDC(r,l);if(!n&&!i&&!o){pdcChart&&(pdcChart.destroy(),pdcChart=null);return}let s=document.getElementById("pdcChart").getContext("2d");pdcChart&&pdcChart.destroy();let d=[];n&&d.push({label:"Device A",data:n,borderWidth:1,pointRadius:2}),i&&d.push({label:"Device B",data:i,borderWidth:1,pointRadius:2}),o&&d.push({label:"Device C",data:o,borderWidth:1,pointRadius:2}),attachDragZoom(pdcChart=new Chart(s,{type:"line",data:{labels:a,datasets:d},options:{responsive:!0,interaction:{mode:"nearest",intersect:!1},scales:{x:{title:{display:!0,text:"Duration (min)"},ticks:{callback(e){let t=this.getLabelForValue?this.getLabelForValue(e):e,r=Number(t);return formatDurationTick(r)}}},y:{title:{display:!0,text:"Mean max power (W)"}}}}}))}function detectMetrics(e){if(!e)return null;let t={};return["power","heartRate","cadence","speed"].forEach(r=>{let l=e[r];t[r]=Array.isArray(l)&&l.some(e=>null!=e)}),t}function updateDeviceSources(){let e=document.getElementById("deviceSources");if(!e)return;let t=[{label:"Device A",parsed:globalParsedA},{label:"Device B",parsed:globalParsedB},{label:"Device C",parsed:globalParsedC}],r={power:"Power",heartRate:"Heart rate",cadence:"Cadence",speed:"Speed"},l="";t.forEach(e=>{let t=detectMetrics(e.parsed);if(l+=`<div class="device-col"><h3>${e.label}</h3>`,!t){l+='<p class="device-empty">No file loaded.</p></div>';return}l+='<ul class="device-metric-list">',Object.keys(r).forEach(e=>{let a=t[e];l+=`<li>${r[e]}: ${a?'<span class="metric-ok">present</span>':'<span class="metric-missing">–</span>'}</li>`}),l+="</ul></div>"}),e.innerHTML=l}function renderSummaryAllMetrics(e){let t=document.getElementById("summaryTable"),r=document.getElementById("comparisonNote");function l(e,t=1){return null==e||Number.isNaN(e)?"-":e.toFixed(t)}let a="<table class='summary-table'><tr><th>Metric</th><th>Device</th><th>Valid samples</th><th>Mean</th><th>Min</th><th>Max</th><th>Zeros</th><th>Dropouts</th></tr>",n={};for(let{key:i,label:o,unit:s}of[{key:"power",label:"Power",unit:"W"},{key:"heartRate",label:"Heart rate",unit:"bpm"},{key:"cadence",label:"Cadence",unit:"rpm"},{key:"speed",label:"Speed",unit:"m/s"}]){let{statsA:d,statsB:c,statsC:u,compBA:m,compCA:p}=computeStatsForMetric(e,i);(d||c||u)&&(n[o]||(n[o]={unit:s,B:null,C:null}),d?a+=`<tr><td>${o}</td><td>A</td><td>${d.count}</td><td>${l(d.mean)}</td><td>${l(d.min)}</td><td>${l(d.max)}</td><td>${d.zeroCount} (${l(d.zeroPct,1)}%)</td><td>${d.dropoutCount} (${l(d.dropoutPct,1)}%)</td></tr>`:a+=`<tr><td>${o}</td><td>A</td><td colspan="6">no data</td></tr>`,c?a+=`<tr><td>${o}</td><td>B</td><td>${c.count}</td><td>${l(c.mean)}</td><td>${l(c.min)}</td><td>${l(c.max)}</td><td>${c.zeroCount} (${l(c.zeroPct,1)}%)</td><td>${c.dropoutCount} (${l(c.dropoutPct,1)}%)</td></tr>`:a+=`<tr><td>${o}</td><td>B</td><td colspan="6">no data</td></tr>`,u?a+=`<tr><td>${o}</td><td>C</td><td>${u.count}</td><td>${l(u.mean)}</td><td>${l(u.min)}</td><td>${l(u.max)}</td><td>${u.zeroCount} (${l(u.zeroPct,1)}%)</td><td>${u.dropoutCount} (${l(u.dropoutPct,1)}%)</td></tr>`:a+=`<tr><td>${o}</td><td>C</td><td colspan="6">no data</td></tr>`,m&&m.sampleCount>0&&(n[o].B={md:l(m.meanDiff,2),mr:l(m.meanRelDiffPct,2),n:m.sampleCount}),p&&p.sampleCount>0&&(n[o].C={md:l(p.meanDiff,2),mr:l(p.meanRelDiffPct,2),n:p.sampleCount}))}a+="</table>",t.innerHTML=a;let h=[];h.push("<strong>Device A is treated as the reference for all comparisons.</strong>"),Object.keys(n).forEach(e=>{let{unit:t,B:r,C:l}=n[e];if(!r&&!l)return;let a=[];r&&a.push(`B: ${r.md} ${t} (${r.mr}%) vs A, n=${r.n}`),l&&a.push(`C: ${l.md} ${t} (${l.mr}%) vs A, n=${l.n}`),h.push(`<strong>${e}</strong> — ${a.join(" | ")}`)}),r.innerHTML=h.join("<br>")}function resetTool(){["fileA","fileB","fileC"].forEach(e=>{let t=document.getElementById(e);t&&(t.value="")});let e=document.getElementById("error");e&&(e.textContent=""),globalParsedA=null,globalParsedB=null,globalParsedC=null,globalAligned=null,Object.keys(metricCharts).forEach(e=>{metricCharts[e]&&(metricCharts[e].destroy(),metricCharts[e]=null)}),pdcChart&&(pdcChart.destroy(),pdcChart=null);let t=document.getElementById("summaryTable"),r=document.getElementById("comparisonNote"),l=document.getElementById("deviceSources");t&&(t.innerHTML=""),r&&(r.innerHTML=""),l&&(l.innerHTML="")}document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("analyzeBtn"),t=document.getElementById("resetToolBtn"),r=document.getElementById("error");t&&t.addEventListener("click",resetTool),document.querySelectorAll(".reset-zoom-btn").forEach(e=>{e.addEventListener("click",()=>{let t=e.getAttribute("data-reset");if("pdc"===t)resetPdcZoom();else{let r={power:"power",hr:"heartRate",cadence:"cadence",speed:"speed"};resetMetricZoom(r[t]||t)}})}),e.addEventListener("click",async()=>{r.textContent="";let e=document.getElementById("summaryTable"),t=document.getElementById("comparisonNote");e&&(e.innerHTML=""),t&&(t.textContent="");let l=document.getElementById("fileA").files[0],a=document.getElementById("fileB").files[0],n=document.getElementById("fileC")?document.getElementById("fileC").files[0]:null;if(!l||!a){r.textContent="Please select at least Device A and B FIT files.";return}try{console.log("Parsing Device A…"),globalParsedA=await parseFitFile(l),console.log("Device A keys:",Object.keys(globalParsedA||{})),console.log("Parsing Device B…"),globalParsedB=await parseFitFile(a),console.log("Device B keys:",Object.keys(globalParsedB||{})),n?(console.log("Parsing Device C…"),globalParsedC=await parseFitFile(n),console.log("Device C keys:",Object.keys(globalParsedC||{}))):globalParsedC=null,globalAligned=alignTimeSeries(globalParsedA,globalParsedB,globalParsedC,1),updateDeviceSources(),renderMetricChart(globalAligned,"power","powerChart"),renderMetricChart(globalAligned,"heartRate","hrChart"),renderMetricChart(globalAligned,"cadence","cadenceChart"),renderMetricChart(globalAligned,"speed","speedChart"),renderSummaryAllMetrics(globalAligned),renderPDC(globalParsedA,globalParsedB,globalParsedC)}catch(i){console.error(i),r.textContent=i.message||"Error parsing or analyzing FIT files."}})});
